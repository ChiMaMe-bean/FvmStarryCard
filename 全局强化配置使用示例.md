# 全局强化配置使用示例

## 简介

`GlobalEnhancementConfig` 是一个全局的强化配置数据结构，在 `startEnhancement()` 方法中从 `enhancement_config.json` 文件加载所有配置数据。加载后，可以在项目的任何地方使用这些配置数据。

## 全局配置数据结构

### 基本结构
```cpp
struct GlobalEnhancementConfig {
    // 基本等级设置
    int maxLevel = 14;          // 最高强化等级
    int minLevel = 1;           // 最低强化等级
    
    // 每个等级的详细配置
    QMap<QString, LevelConfig> levelConfigs;  // 键格式: "0-1", "1-2", etc.
};
```

### 单个等级配置结构
```cpp
struct LevelConfig {
    // 副卡配置
    int subcard1 = 0;           // 副卡1星级 (-1表示无)
    int subcard2 = -1;          // 副卡2星级 (-1表示无)  
    int subcard3 = -1;          // 副卡3星级 (-1表示无)
    
    // 四叶草配置
    QString clover = "无";       // 四叶草类型 ("无", "1级", "2级", ..., "SSS", "蛇草")
    bool cloverBound = false;    // 四叶草绑定状态
    bool cloverUnbound = false;  // 四叶草不绑状态
    
    // 主卡/副卡类型配置
    QString mainCardType = "无";   // 主卡类型
    bool mainCardBound = false;    // 主卡绑定状态
    bool mainCardUnbound = false;  // 主卡不绑状态
    QString subCardType = "无";    // 副卡类型
    bool subCardBound = false;     // 副卡绑定状态
    bool subCardUnbound = false;   // 副卡不绑状态
};
```

## 使用方法

### 1. 包含头文件并访问全局变量

```cpp
#include "starrycard.h"

// 全局变量已在 starrycard.cpp 中定义
extern GlobalEnhancementConfig g_enhancementConfig;
```

### 2. 获取基本等级信息

```cpp
// 获取等级范围
int maxLevel = g_enhancementConfig.maxLevel;
int minLevel = g_enhancementConfig.minLevel;

qDebug() << "强化等级范围:" << minLevel << "-" << maxLevel;

// 在强化循环中使用
for (int currentLevel = minLevel; currentLevel < maxLevel; ++currentLevel) {
    int targetLevel = currentLevel + 1;
    qDebug() << "准备强化:" << currentLevel << "星 → " << targetLevel << "星";
    
    // 获取这个等级的配置
    auto levelConfig = g_enhancementConfig.getLevelConfig(currentLevel, targetLevel);
    // ... 使用配置进行强化
}
```

### 3. 获取特定等级的配置

```cpp
// 获取 3→4 星的强化配置
auto config_3_to_4 = g_enhancementConfig.getLevelConfig(3, 4);

// 检查是否有配置
if (g_enhancementConfig.hasLevelConfig(3, 4)) {
    qDebug() << "找到了 3→4 星的配置";
} else {
    qDebug() << "没有 3→4 星的配置";
}
```

### 4. 使用副卡配置

```cpp
// 获取当前等级的配置
auto levelConfig = g_enhancementConfig.getLevelConfig(5, 6);  // 5→6星

// 检查副卡需求
if (levelConfig.subcard1 > 0) {
    qDebug() << "需要副卡1:" << levelConfig.subcard1 << "星";
}

if (levelConfig.subcard2 > 0) {
    qDebug() << "需要副卡2:" << levelConfig.subcard2 << "星";
} else {
    qDebug() << "不需要副卡2";
}

if (levelConfig.subcard3 > 0) {
    qDebug() << "需要副卡3:" << levelConfig.subcard3 << "星";
} else {
    qDebug() << "不需要副卡3";
}
```

### 5. 使用四叶草配置

```cpp
auto levelConfig = g_enhancementConfig.getLevelConfig(10, 11);  // 10→11星

// 检查四叶草需求
if (levelConfig.clover != "无") {
    qDebug() << "需要四叶草:" << levelConfig.clover;
    
    // 检查绑定状态要求
    if (levelConfig.cloverBound && levelConfig.cloverUnbound) {
        qDebug() << "四叶草绑定状态：任意";
    } else if (levelConfig.cloverBound) {
        qDebug() << "四叶草绑定状态：必须绑定";
    } else if (levelConfig.cloverUnbound) {
        qDebug() << "四叶草绑定状态：必须不绑";
    } else {
        qDebug() << "四叶草绑定状态：无要求";
    }
} else {
    qDebug() << "不需要四叶草";
}
```

### 6. 使用主卡/副卡类型配置

```cpp
auto levelConfig = g_enhancementConfig.getLevelConfig(12, 13);  // 12→13星

// 检查主卡类型
if (levelConfig.mainCardType != "无") {
    qDebug() << "主卡类型:" << levelConfig.mainCardType;
    
    // 检查主卡绑定状态
    if (levelConfig.mainCardBound && levelConfig.mainCardUnbound) {
        qDebug() << "主卡绑定状态：任意";
    } else if (levelConfig.mainCardBound) {
        qDebug() << "主卡绑定状态：必须绑定";
    } else if (levelConfig.mainCardUnbound) {
        qDebug() << "主卡绑定状态：必须不绑";
    }
}

// 检查副卡类型
if (levelConfig.subCardType != "无") {
    qDebug() << "副卡类型:" << levelConfig.subCardType;
    
    // 检查副卡绑定状态
    if (levelConfig.subCardBound && levelConfig.subCardUnbound) {
        qDebug() << "副卡绑定状态：任意";
    } else if (levelConfig.subCardBound) {
        qDebug() << "副卡绑定状态：必须绑定";
    } else if (levelConfig.subCardUnbound) {
        qDebug() << "副卡绑定状态：必须不绑";
    }
}
```

## 实际强化流程示例

```cpp
void StarryCard::performEnhancementWithGlobalConfig()
{
    // 遍历需要强化的等级范围
    for (int currentLevel = g_enhancementConfig.minLevel; 
         currentLevel < g_enhancementConfig.maxLevel; 
         ++currentLevel) {
         
        int targetLevel = currentLevel + 1;
        
        // 获取当前等级的配置
        auto levelConfig = g_enhancementConfig.getLevelConfig(currentLevel, targetLevel);
        
        addLog(QString("开始强化 %1→%2 星").arg(currentLevel).arg(targetLevel), LogType::Info);
        
        // 1. 准备主卡
        if (levelConfig.mainCardType != "无") {
            // 查找并选择主卡
            addLog(QString("查找主卡类型: %1").arg(levelConfig.mainCardType), LogType::Info);
            
            // 根据绑定状态筛选
            bool needBound = levelConfig.mainCardBound && !levelConfig.mainCardUnbound;
            bool needUnbound = levelConfig.mainCardUnbound && !levelConfig.mainCardBound;
            
            // ... 实际的卡片查找和选择逻辑
        }
        
        // 2. 准备副卡
        QList<int> subCardLevels = {levelConfig.subcard1, levelConfig.subcard2, levelConfig.subcard3};
        for (int i = 0; i < subCardLevels.size(); ++i) {
            int subCardLevel = subCardLevels[i];
            if (subCardLevel > 0) {
                addLog(QString("查找副卡%1: %2星").arg(i+1).arg(subCardLevel), LogType::Info);
                // ... 实际的副卡查找和选择逻辑
            }
        }
        
        // 3. 准备四叶草
        if (levelConfig.clover != "无") {
            addLog(QString("查找四叶草: %1").arg(levelConfig.clover), LogType::Info);
            
            // 根据绑定状态筛选四叶草
            bool needBound = levelConfig.cloverBound && !levelConfig.cloverUnbound;
            bool needUnbound = levelConfig.cloverUnbound && !levelConfig.cloverBound;
            
            // ... 实际的四叶草查找和选择逻辑
        }
        
        // 4. 执行强化操作
        addLog("执行强化操作", LogType::Info);
        // ... 实际的强化点击操作
        
        // 5. 验证强化结果
        // ... 检查强化是否成功
    }
}
```

## 配置文件示例

对应的 `enhancement_config.json` 文件格式：

```json
{
    "max_enhancement_level": 14,
    "min_enhancement_level": 1,
    "0-1": {
        "subcard1": 0,
        "subcard2": -1,
        "subcard3": -1,
        "clover": "无",
        "clover_bound": false,
        "clover_unbound": false,
        "main_card_type": "煮蛋器投手",
        "main_card_bound": false,
        "main_card_unbound": true,
        "sub_card_type": "面粉袋",
        "sub_card_bound": false,
        "sub_card_unbound": true
    },
    "1-2": {
        "subcard1": 1,
        "subcard2": -1,
        "subcard3": -1,
        "clover": "1级",
        "clover_bound": true,
        "clover_unbound": false,
        "main_card_type": "煮蛋器投手",
        "main_card_bound": false,
        "main_card_unbound": true,
        "sub_card_type": "面粉袋",
        "sub_card_bound": false,
        "sub_card_unbound": true
    }
}
```

## 调试和日志

```cpp
// 打印所有配置信息（调试用）
void printGlobalConfig() {
    qDebug() << "=== 全局强化配置信息 ===";
    qDebug() << "等级范围:" << g_enhancementConfig.minLevel << "-" << g_enhancementConfig.maxLevel;
    qDebug() << "配置数量:" << g_enhancementConfig.levelConfigs.size();
    
    // 遍历所有等级配置
    for (auto it = g_enhancementConfig.levelConfigs.begin(); 
         it != g_enhancementConfig.levelConfigs.end(); ++it) {
        
        QString levelKey = it.key();
        auto config = it.value();
        
        qDebug() << "等级" << levelKey << ":";
        qDebug() << "  副卡:" << config.subcard1 << config.subcard2 << config.subcard3;
        qDebug() << "  四叶草:" << config.clover;
        qDebug() << "  主卡类型:" << config.mainCardType;
        qDebug() << "  副卡类型:" << config.subCardType;
    }
}
```

## 注意事项

1. **配置加载时机**：全局配置在 `startEnhancement()` 方法中加载，只有在开始强化时才会更新
2. **错误处理**：如果配置文件不存在或格式错误，会使用默认值
3. **性能考虑**：配置数据在内存中，访问速度很快
4. **线程安全**：当前实现不是线程安全的，如需在多线程环境使用需要添加锁保护

## 扩展使用

可以基于全局配置数据构建更复杂的强化逻辑：

```cpp
// 检查是否可以进行强化
bool canEnhanceToLevel(int targetLevel) {
    if (targetLevel < g_enhancementConfig.minLevel || 
        targetLevel > g_enhancementConfig.maxLevel) {
        return false;
    }
    
    int currentLevel = targetLevel - 1;
    auto config = g_enhancementConfig.getLevelConfig(currentLevel, targetLevel);
    
    // 检查是否有必要的配置
    return g_enhancementConfig.hasLevelConfig(currentLevel, targetLevel);
}

// 获取强化所需的材料清单
QStringList getRequiredMaterials(int fromLevel, int toLevel) {
    QStringList materials;
    auto config = g_enhancementConfig.getLevelConfig(fromLevel, toLevel);
    
    if (config.subcard1 > 0) materials << QString("副卡1: %1星").arg(config.subcard1);
    if (config.subcard2 > 0) materials << QString("副卡2: %1星").arg(config.subcard2);
    if (config.subcard3 > 0) materials << QString("副卡3: %1星").arg(config.subcard3);
    if (config.clover != "无") materials << QString("四叶草: %1").arg(config.clover);
    
    return materials;
}
```

这个全局配置系统提供了一个统一、高效的方式来管理和使用强化配置数据，使强化逻辑更加清晰和可维护。 